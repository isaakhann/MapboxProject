<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Weather Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      html,
      body {
        height: 100%;
        overflow: auto;
      }
      body {
        font-family: sans-serif;
        margin: 2em;
        background: #f9f9f9;
        color: #333;
        transition: background 0.4s, color 0.4s;
      }
      body.dark {
        background: #1e1e1e;
        color: #eee;
      }
      h1 {
        text-align: center;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
        background: white;
      }
      body.dark table {
        background: #2e2e2e;
        color: #eee;
      }
      td,
      th {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #0078a8;
        color: white;
      }
      .controls {
        text-align: center;
        margin: 20px 0;
      }
      button {
        margin: 0 10px;
        padding: 8px 14px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: #0078a8;
        color: white;
        transition: background 0.3s;
      }
      button:hover {
        background: #005f7a;
      }
      canvas {
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <h1>Weather Data (Last 7 Days)</h1>
    <div class="controls">
      <button id="toggle-dark">Toggle Dark Mode</button>
      <button id="export-csv">Download CSV</button>
    </div>
    <div id="weather-table">Loading...</div>
    <canvas id="temp-wind-chart" height="400"></canvas>
    <canvas id="precip-chart" height="400"></canvas>

    <script>
      // ---------- Helpers ----------
      const p = new URLSearchParams(location.search);
      const lat = parseFloat(p.get('lat'));
      const lon = parseFloat(p.get('lon'));

      const days = parseInt(p.get('days') || '7', 10);
      // Per-turbine parameters (defaults OK if not passed)
      const rated_power_mw = parseFloat(p.get('rated_power_mw') || '3.6'); // per turbine
      const cut_in = parseFloat(p.get('cut_in') || '3'); // m/s
      const rated = parseFloat(p.get('rated') || '12'); // m/s
      const cut_out = parseFloat(p.get('cut_out') || '25'); // m/s

      // Per-panel parameters (defaults OK if not passed)
      const panel_area_m2 = parseFloat(p.get('panel_area_m2') || '2.0');
      const panel_efficiency = parseFloat(p.get('panel_efficiency') || '0.20'); // 20%

      let dailyRowsForCsv = []; // enriched rows for export

      function fmt(n, d = 2) {
        return n === null || n === undefined || Number.isNaN(n)
          ? 'N/A'
          : Number(n).toFixed(d);
      }

      function capacityFactorFromWind(v_ms, ci = 3, r = 12, co = 25) {
        if (v_ms < ci || v_ms >= co) return 0;
        if (v_ms >= r) return 1;
        const x = (v_ms - ci) / (r - ci);
        return Math.max(0, Math.min(1, x ** 3));
      }

      function groupByDay(times, vals) {
        const out = {};
        for (let i = 0; i < times.length; i++) {
          const day = String(times[i]).split('T')[0];
          (out[day] ||= []).push(Number(vals[i]));
        }
        return out;
      }
      const sum = (a) => a.reduce((x, y) => x + (Number(y) || 0), 0);
      const mean = (a) => (a.length ? sum(a) / a.length : NaN);

      // ---------- Main ----------
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
        document.getElementById('weather-table').textContent =
          'Missing coordinates!';
      } else {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - (days - 1));
        const startISO = start.toISOString().split('T')[0];
        const endISO = end.toISOString().split('T')[0];

        // Daily + Hourly in one go
        const url =
          `https://api.open-meteo.com/v1/forecast` +
          `?latitude=${lat}&longitude=${lon}` +
          `&start_date=${startISO}&end_date=${endISO}` +
          `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,` +
          `windspeed_10m_max,winddirection_10m_dominant,uv_index_max,shortwave_radiation_sum` +
          `&hourly=wind_speed_10m,uv_index,shortwave_radiation` +
          `&timezone=auto`;

        fetch(url)
          .then((r) => r.json())
          .then((data) => {
            if (!data.daily?.time) {
              document.getElementById('weather-table').textContent =
                'No weather data found.';
              return;
            }

            const daysArr = data.daily.time;
            // Hourly series (used for UV average and wind energy per turbine)
            const hTimes = data.hourly?.time || [];
            const hWind = data.hourly?.wind_speed_10m || [];
            const hUV = data.hourly?.uv_index || [];

            const windByDay = groupByDay(hTimes, hWind);
            const uvByDay = groupByDay(hTimes, hUV);

            // Daily solar: shortwave_radiation_sum is MJ/m²  → convert to kWh/m²
            const ghi_kwh_m2_daily = (
              data.daily.shortwave_radiation_sum || []
            ).map((mj) => (mj ?? 0) / 3.6);

            // Build enriched daily rows
            const rows = daysArr.map((d, i) => {
              // UV: use hourly average when available, else fall back to daily uv_index_max
              const uv_avg =
                (uvByDay[d]?.length
                  ? mean(uvByDay[d])
                  : data.daily.uv_index_max?.[i]) ?? NaN;

              // Wind energy PER TURBINE (MWh/day)
              let wind_mwh_per_turbine = NaN;
              if (rated_power_mw > 0 && windByDay[d]?.length) {
                const cfHours = windByDay[d].map((v) =>
                  capacityFactorFromWind(v, cut_in, rated, cut_out)
                );
                wind_mwh_per_turbine = sum(cfHours) * rated_power_mw; // 1 h samples
              }

              // Solar energy PER PANEL (kWh/day)
              let solar_kwh_per_panel = NaN;
              if (panel_area_m2 > 0 && panel_efficiency > 0) {
                // Energy ≈ GHI(kWh/m²) * area(m²) * efficiency
                solar_kwh_per_panel =
                  (ghi_kwh_m2_daily[i] || 0) * panel_area_m2 * panel_efficiency;
              }

              return {
                date: d,
                tmax: data.daily.temperature_2m_max?.[i],
                tmin: data.daily.temperature_2m_min?.[i],
                pprob: data.daily.precipitation_probability_max?.[i],
                psum: data.daily.precipitation_sum?.[i],
                wmax: data.daily.windspeed_10m_max?.[i],
                wdir: data.daily.winddirection_10m_dominant?.[i],
                uv_avg,
                wind_mwh_per_turbine,
                solar_kwh_per_panel,
              };
            });

            dailyRowsForCsv = rows;

            // Render table
            const rowsHtml = rows
              .map(
                (r) => `
            <tr>
              <td>${r.date}</td>
              <td>${fmt(r.tmax, 1)}°C</td>
              <td>${fmt(r.tmin, 1)}°C</td>
              <td>${fmt(r.pprob, 0)}%</td>
              <td>${fmt(r.psum, 1)} mm</td>
              <td>${fmt(r.wmax, 1)} km/h</td>
              <td>${fmt(r.wdir, 0)}°</td>
              <td>${fmt(r.uv_avg, 1)}</td>
              <td style="color:${energyColor(r.wind_mwh_per_turbine, 'wind')}">
  ${
    Number.isNaN(r.wind_mwh_per_turbine)
      ? 'N/A'
      : fmt(r.wind_mwh_per_turbine, 2)
  }
</td>
<td style="color:${energyColor(r.solar_kwh_per_panel, 'solar')}">
  ${Number.isNaN(r.solar_kwh_per_panel) ? 'N/A' : fmt(r.solar_kwh_per_panel, 1)}
</td>

            </tr>
          `
              )
              .join('');

            const table = `
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Temp Max</th>
                  <th>Temp Min</th>
                  <th>Precip Prob</th>
                  <th>Precipitation</th>
                  <th>Wind Speed</th>
                  <th>Wind Dir</th>
                  <th>UV Index (avg)</th>
                  <th>Wind Energy / Turbine (MWh)</th>
                  <th>Solar Energy / Panel (kWh)</th>
                </tr>
              </thead>
              <tbody>${rowsHtml}</tbody>
            </table>`;
            document.getElementById('weather-table').innerHTML = table;

            // Charts (unchanged)
            const labels = daysArr;
            const tmax = data.daily.temperature_2m_max;
            const tmin = data.daily.temperature_2m_min;
            const windMax = data.daily.windspeed_10m_max;
            const precipProb = data.daily.precipitation_probability_max;
            const precipSum = data.daily.precipitation_sum;

            new Chart(
              document.getElementById('temp-wind-chart').getContext('2d'),
              {
                type: 'line',
                data: {
                  labels,
                  datasets: [
                    {
                      label: 'Temp Max (°C)',
                      data: tmax,
                      borderColor: 'rgba(255,99,132,1)',
                      backgroundColor: 'rgba(255,99,132,0.2)',
                      fill: true,
                      tension: 0.3,
                    },
                    {
                      label: 'Temp Min (°C)',
                      data: tmin,
                      borderColor: 'rgba(54,162,235,1)',
                      backgroundColor: 'rgba(54,162,235,0.2)',
                      fill: true,
                      tension: 0.3,
                    },
                    {
                      label: 'Wind Speed (km/h)',
                      data: windMax,
                      borderColor: 'rgba(255,206,86,1)',
                      backgroundColor: 'rgba(255,206,86,0.2)',
                      fill: true,
                      tension: 0.3,
                    },
                  ],
                },
                options: {
                  plugins: {
                    title: {
                      display: true,
                      text: 'Temperature and Wind Speed Trends',
                    },
                    legend: { position: 'top' },
                  },
                  interaction: { intersect: false, mode: 'index' },
                  scales: { y: { beginAtZero: true } },
                },
              }
            );

            new Chart(
              document.getElementById('precip-chart').getContext('2d'),
              {
                type: 'bar',
                data: {
                  labels,
                  datasets: [
                    {
                      label: 'Precipitation Probability (%)',
                      data: precipProb,
                      backgroundColor: 'rgba(153,102,255,0.6)',
                    },
                    {
                      label: 'Precipitation (mm)',
                      data: precipSum,
                      backgroundColor: 'rgba(75,192,192,0.6)',
                    },
                  ],
                },
                options: {
                  plugins: {
                    title: { display: true, text: 'Precipitation Trends' },
                    legend: { position: 'top' },
                  },
                  interaction: { intersect: false, mode: 'index' },
                  scales: { y: { beginAtZero: true } },
                },
              }
            );
          })
          .catch((err) => {
            console.error(err);
            document.getElementById('weather-table').textContent =
              'Failed to fetch weather data.';
          });
      }
      function energyColor(value, type) {
        if (Number.isNaN(value)) return 'inherit';
        if (type === 'wind') {
          if (value < 20) return 'red';
          if (value < 80) return 'orange'; // yellowish
          return 'green';
        }
        if (type === 'solar') {
          if (value < 2) return 'red';
          if (value < 5) return 'orange'; // yellowish
          return 'green';
        }
        return 'inherit';
      }

      // ---------- UI actions ----------
      document.getElementById('toggle-dark').addEventListener('click', () => {
        document.body.classList.toggle('dark');
      });

      document.getElementById('export-csv').addEventListener('click', () => {
        if (!dailyRowsForCsv.length) {
          alert('No data to export!');
          return;
        }
        let csv =
          'Date,Temp Max (°C),Temp Min (°C),Precip Prob (%),Precipitation (mm),Wind Speed (km/h),Wind Dir (°),UV Index (avg),Wind Energy / Turbine (MWh),Solar Energy / Panel (kWh)\n';
        for (const r of dailyRowsForCsv) {
          csv += `${r.date},${fmt(r.tmax, 1)},${fmt(r.tmin, 1)},${fmt(
            r.pprob,
            0
          )},${fmt(r.psum, 1)},${fmt(r.wmax, 1)},${fmt(r.wdir, 0)},${fmt(
            r.uv_avg,
            1
          )},${
            Number.isNaN(r.wind_mwh_per_turbine)
              ? ''
              : fmt(r.wind_mwh_per_turbine, 2)
          },${
            Number.isNaN(r.solar_kwh_per_panel)
              ? ''
              : fmt(r.solar_kwh_per_panel, 1)
          }\n`;
        }
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'weather_data.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
